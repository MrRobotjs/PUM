{# app/templates/admin/users.html #}
{% extends "base.html" %}
{% from "_formhelpers.html" import render_field, render_checkbox_field, render_submit_field %}

{% block content %}
<div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="flex flex-col sm:flex-row items-center justify-between mb-6">
        <h1 class="text-2xl sm:text-3xl font-bold text-plex-text-primary dark:text-white mb-4 sm:mb-0">
            Manage Plex Users
        </h1>
    </div>

    <!-- Action Buttons/Forms Row: Sync and Purge -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
        <div class="bg-plex-surface dark:bg-gray-800 shadow-xl rounded-lg flex flex-col">
            <div class="px-6 py-4 bg-plex-accent/10 dark:bg-plex-accent/20 border-b border-plex-accent/30">
                <h3 class="text-lg font-semibold text-plex-accent dark:text-plex-accent-hover">
                    <i class="fas fa-sync-alt fa-fw mr-2"></i>Plex Synchronization
                </h3>
            </div>
            <div class="p-6 flex-grow flex flex-col justify-between">
                <div class="mt-auto"> 
                    <form action="{{ url_for('admin_users.sync_plex_users') }}" method="POST" id="syncPlexUsersForm">
                        {{ csrf_form.hidden_tag() }}
                        <button type="submit" 
                                class="w-full btn-base btn-normal bg-blue-600 hover:bg-blue-700 text-white focus:ring-blue-500" 
                                id="syncPlexUsersButton">
                            Sync Users from Plex Server
                            <span class="loading-spinner-sm ms-2 align-[-0.125em]" role="status" aria-hidden="true" style="display: none;"></span>
                        </button>
                        <p class="form-description-text mt-2 text-center">Imports/updates users from your Plex account's shared user list.</p>
                    </form>
                </div>
            </div>
        </div>
        
        {% if users %}
        <div class="bg-plex-surface dark:bg-gray-800 shadow-xl rounded-lg flex flex-col">
            <div class="px-6 py-4 bg-yellow-400/10 dark:bg-yellow-600/20 border-b border-yellow-500/30">
                <h3 class="text-lg font-semibold text-yellow-600 dark:text-yellow-400">
                    <i class="fas fa-user-slash fa-fw mr-2"></i>Purge Inactive Users
                </h3>
            </div>
            <div class="p-6 flex-grow">
                <form method="POST" action="{{ url_for('admin_users.manage_users_list', **request.args) }}" novalidate class="space-y-4">
                    {{ purge_form.hidden_tag() }}
                    <input type="hidden" name="action" value="purge">
                    
                    {{ render_field(purge_form.days_inactive, type="number", min="1", focus_theme='plex', input_extra_class="text-sm", placeholder="Days Inactive (e.g., 30)") }}
                    {{ render_checkbox_field(purge_form.exempt_sharers, focus_theme='plex') }}
                    {{ render_checkbox_field(purge_form.exempt_home_users, focus_theme='plex') }}
                    
                    <div class="pt-2">
                        {{ render_submit_field(purge_form.submit_purge_users, 
                                                class="w-full bg-yellow-500 hover:bg-yellow-600 text-gray-900 focus:ring-yellow-400", 
                                                text="Purge Inactive Users Now", 
                                                icon_class="fas fa-exclamation-triangle",
                                                onclick="return confirm('Purge inactive users based on these criteria? This action cannot be undone.');") }}
                    </div>
                </form>
            </div>
            <div class="px-6 py-4 bg-gray-50 dark:bg-gray-700/50 border-t border-plex-border dark:border-gray-700 rounded-b-lg mt-auto"> 
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Filter and Sort Form Card -->
    <div class="bg-plex-surface dark:bg-gray-800 shadow-xl rounded-lg mb-8">
        <div class="px-6 py-4 border-b border-plex-border dark:border-gray-700 flex justify-between items-center">
            <h3 class="text-lg font-semibold text-plex-text-primary dark:text-white"><i class="fas fa-filter fa-fw mr-2"></i>Filter & Sort Users</h3>
            <button type="button" class="btn-base btn-sm btn-secondary filter-toggle-btn" 
                    id="filterSortToggleButton" aria-expanded="false" aria-controls="collapseFilterSort">
                Toggle Filters 
                <i class="fas fa-chevron-down ms-1"></i><i class="fas fa-chevron-up ms-1"></i>
            </button>
        </div>
        <div class="hidden" id="collapseFilterSort"> 
            <div class="p-6">
                <form method="GET" action="{{ url_for('admin_users.manage_users_list') }}" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4 items-end">
                    <div class="sm:col-span-2 md:col-span-3 lg:col-span-2 xl:col-span-2">
                        {{ render_field(filter_sort_form.search, 
                                        placeholder="Search User, Email, Discord...", 
                                        focus_theme='plex', input_extra_class="text-sm",
                                        container_class="mb-0", label_visible=True) }}
                    </div>
                    <div>{{ render_field(filter_sort_form.sort_by, label_visible=True, focus_theme='plex', input_extra_class="text-sm", container_class="mb-0") }}</div>
                    <div>{{ render_field(filter_sort_form.sort_order, label_visible=True, focus_theme='plex', input_extra_class="text-sm", container_class="mb-0") }}</div>
                    <div>{{ render_field(filter_sort_form.filter_is_home_user, label_visible=True, focus_theme='plex', input_extra_class="text-sm", container_class="mb-0") }}</div>
                    <div>{{ render_field(filter_sort_form.filter_shares_back, label_visible=True, focus_theme='plex', input_extra_class="text-sm", container_class="mb-0") }}</div>
                    <div>{{ render_field(filter_sort_form.filter_is_purge_whitelisted, label_visible=True, focus_theme='plex', input_extra_class="text-sm", container_class="mb-0") }}</div>
                    <div>{{ render_field(filter_sort_form.filter_is_discord_bot_whitelisted, label_visible=True, focus_theme='plex', input_extra_class="text-sm", container_class="mb-0") }}</div>
                    
                    <div class="flex space-x-2 sm:col-span-2 md:col-span-1 lg:col-auto xl:col-auto pt-5 sm:pt-0 md:col-start-auto">
                        {{ render_submit_field(filter_sort_form.filter_submit, class="flex-grow", size="normal", text="Apply") }}
                        <a href="{{ url_for('admin_users.manage_users_list') }}" class="btn-base btn-normal btn-secondary flex-grow text-center">Clear</a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Bulk Action Header -->
    {% if users %}
    <div class="mb-4 flex flex-col sm:flex-row sm:items-center sm:justify-between">
        <div class="flex items-center mb-2 sm:mb-0">
            <div class="form-check me-3">
                <input class="form-check-input h-5 w-5 text-plex-accent border-gray-300 dark:border-gray-600 rounded focus:ring-plex-accent" 
                       type="checkbox" id="selectAllUsers" title="Select/Deselect All">
                <label class="form-check-label text-sm font-medium text-plex-text-secondary dark:text-gray-300 ms-2" for="selectAllUsers">
                    Select All (<span id="selectedUserCount">0</span>)
                </label>
            </div>
        </div>
        
        <div class="flex items-center space-x-2">
            <button type="button" id="openMassEditModalButton" 
                    class="btn-base btn-sm bg-purple-600 hover:bg-purple-700 text-white focus:ring-purple-500"
                    style="display: none;" title="Mass Edit Selected Users">
                <i class="fas fa-users-cog me-1"></i> Mass Edit
            </button>
            {# Direct remove button and its form are removed #}
        </div>
    </div>
    {% endif %}

    <!-- User Cards -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
        {% if users %}
            {% set default_avatar_path = url_for('static', filename='images/default_avatar.png') %}
            {% set default_avatar_onerror_js = "this.onerror=null; this.src='" ~ default_avatar_path ~ "';" %}
            {% set discord_bot_token_is_set = app_settings.get('DISCORD_BOT_TOKEN') %}

            {% for user_item in users %}
            <div class="user-card flex flex-col h-full bg-plex-surface dark:bg-gray-800 rounded-lg shadow-lg overflow-hidden"> 
                <div class="px-4 py-3 border-b border-plex-border dark:border-gray-700 flex items-center space-x-3">
                    <div class="form-check flex-shrink-0">
                         <input type="checkbox" name="selected_user_ids_for_js" value="{{ user_item.id }}" 
                                class="user-checkbox form-check-input h-5 w-5 text-plex-accent border-gray-300 dark:border-gray-600 rounded focus:ring-plex-accent" 
                                id="user-checkbox-{{user_item.id}}">
                    </div>
                    <img src="{{ user_item.plex_thumb_url if user_item.plex_thumb_url else default_avatar_path }}"
                         alt="{{ user_item.plex_username or user_item.plex_email }} avatar"
                         class="w-10 h-10 object-cover rounded-full flex-shrink-0"
                         onerror="{{ default_avatar_onerror_js | safe }}">
                    <h3 class="text-md font-semibold text-plex-text-primary dark:text-white truncate flex-grow" title="{{ user_item.plex_username or user_item.plex_email or 'N/A' }}">
                       {{ user_item.plex_username or user_item.plex_email or 'N/A' }}
                    </h3>
                </div>

                <div class="p-4 space-y-1.5 text-sm flex-grow">
                    <div><span class="font-medium text-plex-text-secondary dark:text-gray-400">Plex Email:</span> <span class="text-plex-text-primary dark:text-gray-200 ms-1 break-all">{{ user_item.plex_email or 'N/A' }}</span></div>
                    <div>
                        <span class="font-medium text-plex-text-secondary dark:text-gray-400">Discord Username:</span>
                        {% if user_item.discord_id %}
                            {% if user_item.discord_username %}
                                <span class="ms-1 text-plex-text-primary dark:text-gray-200"><i class="fa-brands fa-discord text-blue-500 dark:text-blue-400 me-1"></i>{{ user_item.discord_username }}</span>
                            {% else %}
                                <span class="ms-1 italic text-gray-500 dark:text-gray-400">(Username not fetched)</span>
                                {% if not discord_bot_token_is_set %}
                                    <span class="custom-tooltip-container ms-1">
                                        <i class="fas fa-info-circle text-gray-400 dark:text-gray-500" tabindex="0"></i>
                                        <span class="custom-tooltip-text">Discord username cannot be fetched because the Discord Bot Token is not configured.</span>
                                    </span>
                                {% endif %}
                            {% endif %}
                        {% else %}<span class="ms-1 italic text-gray-500 dark:text-gray-400">Not Linked</span>{% endif %}
                    </div>
                    {% if user_item.discord_id %}
                    <div>
                        <span class="font-medium text-plex-text-secondary dark:text-gray-400">Discord ID:</span>
                        <span class="text-plex-text-primary dark:text-gray-200 ms-1 font-mono" 
                              data-modal-target="discordIdModal-{{ user_item.id }}" title="Click to view (if modal JS is active)"
                        >{{ user_item.discord_id }}</span>
                    </div>
                    {% endif %}
                    <div><span class="font-medium text-plex-text-secondary dark:text-gray-400">Last Streamed:</span> <span class="text-plex-text-primary dark:text-gray-200 ms-1">{{ user_item.last_streamed_at | time_ago(default="Never or Unknown") }}</span></div>
                    
                    <div class="mt-3 flex flex-wrap gap-2">
                        {% if user_item.is_plex_home_user %}
                            <span class="badge bg-blue-100 text-blue-800 dark:bg-blue-500 dark:text-blue-100" title="Plex Home User">
                                <i class="fas fa-home fa-fw me-1"></i>Home
                            </span>
                        {% endif %}
                        {% if user_item.shares_back %}
                            <span class="badge bg-green-100 text-green-800 dark:bg-green-500 dark:text-green-100" title="Shares Plex server back">
                                <i class="fas fa-exchange-alt fa-fw me-1"></i>Shares
                            </span>
                        {% endif %}
                        {% if user_item.is_purge_whitelisted %}
                            <span class="badge bg-yellow-100 text-yellow-800 dark:bg-yellow-400 dark:text-yellow-900" title="Individually whitelisted from purging">
                                <i class="fas fa-shield-alt fa-fw me-1"></i>Purge WL
                            </span>
                        {% endif %}
                        {% if user_item.plex_username and user_item.plex_username|lower in discord_bot_whitelist_plex_usernames %}
                            <span class="badge bg-teal-100 text-teal-800 dark:bg-teal-500 dark:text-teal-100" title="On Discord Bot Whitelist">
                                <i class="fa-brands fa-discord fa-fw me-1"></i>Bot WL
                            </span>
                        {% endif %}
                    </div>
                </div>

                <div class="px-4 py-3 bg-gray-100 dark:bg-gray-700/50 border-t border-plex-border dark:border-gray-700 text-center space-x-2">
                    <a href="{{ url_for('admin_users.edit_user', user_id=user_item.id, **request.args) }}"
                       class="btn-base btn-sm bg-blue-600 hover:bg-blue-700 text-white focus:ring-blue-500" title="Edit User Details">
                        <i class="fas fa-edit fa-fw me-1"></i> Edit
                    </a>
                    <form action="{{ url_for('admin_users.remove_user', user_id=user_item.id) }}" method="POST" class="inline-block"
                          onsubmit="return confirm('Remove {{ user_item.plex_username or user_item.plex_email }}? This removes from Plex and app.');">
                        {{ csrf_form.hidden_tag() }}
                        <button type="submit" class="btn-base btn-sm bg-red-600 hover:bg-red-700 text-white focus:ring-red-500" title="Remove User">
                            <i class="fas fa-user-times fa-fw me-1"></i> Remove
                        </button>
                    </form>
                </div>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="sm:col-span-2 lg:col-span-3 xl:col-span-4">
            <div class="mt-8 p-6 bg-plex-surface dark:bg-gray-800 rounded-lg shadow-md text-center">
                <i class="fas fa-info-circle fa-2x text-blue-500 dark:text-blue-400 mb-3"></i>
                <p class="text-lg text-plex-text-secondary dark:text-gray-400">
                {% if filter_sort_form.search.data or request.args.get('filter_home') or request.args.get('filter_shares') or request.args.get('filter_p_wl') or request.args.get('filter_d_wl') %}
                    No users found matching your current filters.
                    <a href="{{ url_for('admin_users.manage_users_list', sort_by=(filter_sort_form.sort_by.data or 'plex_username'), sort_order=(filter_sort_form.sort_order.data or 'asc')) }}" class="text-plex-accent hover:underline font-medium">Clear all filters</a>.
                {% else %}
                    No Plex users are currently managed. Try "Sync Users from Plex Server" above.
                {% endif %}
                </p>
            </div>
        </div>
    {% endif %}

    <!-- Mass Edit Modal -->
    <div id="massEditModal" class="modal hidden" tabindex="-1" aria-hidden="true">
        <div class="modal-backdrop" data-modal-hide="massEditModal"></div>
        <div class="modal-content max-w-xl"> 
            <div class="modal-header">
                <h3 class="modal-title">Mass Edit Selected Users (<span id="massEditSelectedCountModalDisplay">0</span>)</h3>
                <button type="button" class="modal-close-button" data-modal-hide="massEditModal" aria-label="Close modal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="massEditActualForm" method="POST" action="{{ url_for('admin_users.mass_action_users', **request.args) }}"> 
                {{ csrf_form.hidden_tag() }}
                <div id="hiddenUserIdsContainer"></div> 
                <input type="hidden" name="mass_action_type" id="massActionTypeInput" value="">

                <div class="modal-body">
                    <p class="text-sm text-yellow-600 dark:text-yellow-300 bg-yellow-100 dark:bg-yellow-900/30 p-3 rounded-md mb-4">
                        <i class="fas fa-exclamation-triangle fa-fw"></i>
                        Warning: Actions taken here apply to all selected users and may take time to process for large selections.
                    </p>

                    <div class="mb-6 border-b border-plex-border dark:border-gray-700 pb-6">
                        <h4 class="text-md font-semibold mb-2">Update Libraries</h4>
                        {% if mass_edit_form %} 
                            {{ render_field(mass_edit_form.libraries_to_apply,
                                            label_visible=True, 
                                            focus_theme='plex',
                                            size="8",
                                            input_extra_class="min-h-[150px]") }} 
                        {% else %}
                            <p class="text-red-500">Library selection form not available.</p>
                        {% endif %}
                        <button type="button" id="submitMassUpdateLibraries" 
                                class="btn-base btn-normal bg-blue-600 hover:bg-blue-700 text-white focus:ring-blue-500 mt-3 w-full sm:w-auto">
                            <i class="fas fa-cogs fa-fw mr-2"></i>Apply Library Changes
                        </button>
                    </div>

                    <div>
                        <h4 class="text-md font-semibold mb-2 text-red-600 dark:text-red-400">Delete Users</h4>
                        <p class="text-sm text-plex-text-secondary dark:text-gray-400 mb-3">
                            This will remove selected users from this application AND attempt to remove them from your Plex server friends. This action is irreversible.
                        </p>
                        <button type="button" id="submitMassDeleteUsers"
                                class="btn-base btn-normal bg-red-600 hover:bg-red-700 text-white focus:ring-red-500 w-full sm:w-auto">
                            <i class="fas fa-trash-alt fa-fw mr-2"></i>Delete Selected Users
                        </button>
                    </div>
                </div>
                <div class="modal-footer">
                     <div id="massEditProgressArea" class="flex-grow me-3 hidden">
                        <p id="massEditProgressMessage" 
                           class="text-xs sm:text-sm font-medium text-plex-text-primary dark:text-gray-200 mb-1 truncate">
                            Processing...
                        </p>
                        <div class="progress-bar-container">
                            <div id="massEditProgressBar" class="progress-bar" style="width: 0%"></div>
                        </div>
                        <p id="massEditErrorDetail" class="text-xs text-red-500 dark:text-red-300 mt-0.5 truncate"></p>
                    </div>
                    <button type="button" id="massEditCancelButton" data-modal-hide="massEditModal" class="btn-base btn-normal btn-secondary">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts_extra %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- Element Selectors ---
    const selectAllCheckbox = document.getElementById('selectAllUsers');
    const userCardCheckboxes = document.querySelectorAll('input.user-checkbox');
    const openMassEditModalButton = document.getElementById('openMassEditModalButton');
    const selectedUserCountDisplay = document.getElementById('selectedUserCount');
    const massEditSelectedCountModalDisplay = document.getElementById('massEditSelectedCountModalDisplay');

    const massEditModal = document.getElementById('massEditModal');
    const massEditModalHideTriggers = document.querySelectorAll('[data-modal-hide="massEditModal"]'); // Includes backdrop, X, and Cancel button
    const massEditActualForm = document.getElementById('massEditActualForm');
    const massEditHiddenUserIdsContainer = document.getElementById('hiddenUserIdsContainer');
    const massActionTypeInput = document.getElementById('massActionTypeInput');
    const submitMassUpdateLibsBtn = document.getElementById('submitMassUpdateLibraries');
    const submitMassDeleteUsersBtn = document.getElementById('submitMassDeleteUsers');
    const massEditProgressArea = document.getElementById('massEditProgressArea');
    const massEditProgressMessage = document.getElementById('massEditProgressMessage');
    const massEditProgressBar = document.getElementById('massEditProgressBar');
    const massEditErrorDetail = document.getElementById('massEditErrorDetail');
    const massEditCancelButton = document.getElementById('massEditCancelButton'); 

    let currentFetchController = null;
    let totalUsersForMassAction = 0;
    let operationInProgress = false; 

    // --- Helper Functions ---
    function getSelectedUserIds() {
        return Array.from(userCardCheckboxes).filter(cb => cb.checked).map(cb => cb.value);
    }

    function resetModalState(isOpening = false) {
        if(massEditProgressArea) massEditProgressArea.classList.add('hidden');
        if(massEditProgressBar) {
            massEditProgressBar.style.width = '0%';
            massEditProgressBar.style.backgroundColor = '';
        }
        if(massEditProgressMessage) massEditProgressMessage.innerHTML = 'Processing...';
        if(massEditErrorDetail) {
            massEditErrorDetail.innerHTML = '';
            massEditErrorDetail.classList.add('hidden');
        }
        
        if(submitMassUpdateLibsBtn) submitMassUpdateLibsBtn.disabled = false;
        if(submitMassDeleteUsersBtn) submitMassDeleteUsersBtn.disabled = false;
        
        if(massEditCancelButton) {
            massEditCancelButton.disabled = false;
            massEditCancelButton.innerHTML = 'Cancel'; // Always reset to "Cancel"
            massEditCancelButton.classList.remove('bg-green-500', 'hover:bg-green-600', 'dark:bg-green-600', 'dark:hover:bg-green-700', 'text-white', 'bg-yellow-500', 'hover:bg-yellow-600');
            massEditCancelButton.classList.add('btn-secondary'); 
        }
        operationInProgress = false; 
    }
    
    function hideModalAndMaybeReload(reloadPage = false) {
        if (massEditModal && !massEditModal.classList.contains('hidden')) {
            massEditModal.classList.add('hidden');
            massEditModal.setAttribute('aria-hidden', 'true');
        }
        if (currentFetchController) {
            currentFetchController.abort();
            console.log("Fetch aborted by modal close/action completion.");
        }
        currentFetchController = null;
        operationInProgress = false; 
        resetModalState(true); // Reset modal to its initial clean state
        if (reloadPage) {
            window.location.reload(); 
        }
    }

    // --- Select All / Bulk Action Button Logic ---
    function updateSelectedCountAndButtonVisibility() {
        const selectedIds = getSelectedUserIds();
        const count = selectedIds.length;
        totalUsersForMassAction = count; 
        
        if(selectedUserCountDisplay) selectedUserCountDisplay.textContent = count;
        if(massEditSelectedCountModalDisplay) massEditSelectedCountModalDisplay.textContent = count;

        const showButtons = count > 0;
        if (openMassEditModalButton) {
            openMassEditModalButton.style.display = showButtons ? 'inline-flex' : 'none';
        }
    }

    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('click', function(event) {
            const isChecked = event.target.checked;
            userCardCheckboxes.forEach(function(checkbox) {
                checkbox.checked = isChecked;
                checkbox.closest('.user-card')?.classList.toggle('selected', isChecked);
            });
            updateSelectedCountAndButtonVisibility();
        });
    }

    userCardCheckboxes.forEach(function(checkbox) {
        checkbox.addEventListener('change', function() {
            this.closest('.user-card')?.classList.toggle('selected', this.checked);
            updateSelectedCountAndButtonVisibility();
            if (selectAllCheckbox) {
                const total = userCardCheckboxes.length;
                const checkedCount = getSelectedUserIds().length;
                selectAllCheckbox.checked = (total > 0 && total === checkedCount);
                selectAllCheckbox.indeterminate = (checkedCount > 0 && checkedCount < total);
            }
        });
        if (checkbox.checked) checkbox.closest('.user-card')?.classList.add('selected');
    });
    
    updateSelectedCountAndButtonVisibility();
    if(selectAllCheckbox && userCardCheckboxes.length > 0) {
        const total = userCardCheckboxes.length;
        const checkedCount = getSelectedUserIds().length;
        selectAllCheckbox.checked = (total > 0 && total === checkedCount);
        selectAllCheckbox.indeterminate = (checkedCount > 0 && checkedCount < total);
    }

    const userCards = document.querySelectorAll('.user-card');
    userCards.forEach(function(card) {
        card.addEventListener('click', function(event) {
            if (event.target.closest('button, a, .form-check-input, [data-modal-target]')) return;
            const checkbox = card.querySelector('.user-checkbox');
            if (checkbox) {
                checkbox.checked = !checkbox.checked;
                checkbox.dispatchEvent(new Event('change', { bubbles: true }));
            }
        });
    });

    const syncPlexUsersForm = document.getElementById('syncPlexUsersForm');
    const syncPlexUsersButton = document.getElementById('syncPlexUsersButton');
    if (syncPlexUsersForm && syncPlexUsersButton) {
        syncPlexUsersForm.addEventListener('submit', function(event) {
            if (!confirm('Sync users from Plex server? This might take a moment. Continue?')) {
                event.preventDefault(); return;
            }
            syncPlexUsersButton.disabled = true;
            syncPlexUsersButton.querySelector('.loading-spinner-sm')?.style.display == 'inline-block';
        });
    }

    const filterToggleButton = document.getElementById('filterSortToggleButton');
    const collapseFilterSortDiv = document.getElementById('collapseFilterSort');
    if (filterToggleButton && collapseFilterSortDiv) {
        const urlParams = new URLSearchParams(window.location.search);
        let filtersActive = ['search', 'sort_by', 'sort_order', 'filter_home', 'filter_shares', 'filter_p_wl', 'filter_d_wl']
            .some(param => {
                const val = urlParams.get(param);
                return val && val !== '' && 
                       !((param === 'sort_by' && val === 'plex_username') && (urlParams.get('sort_order') === 'asc' || !urlParams.has('sort_order'))) &&
                       !((param === 'sort_order' && val === 'asc') && (urlParams.get('sort_by') === 'plex_username' || !urlParams.has('sort_by')));
            });
        if (filtersActive) {
            collapseFilterSortDiv.classList.remove('hidden');
            filterToggleButton.setAttribute('aria-expanded', 'true');
            filterToggleButton.classList.add('expanded');
        }
        filterToggleButton.addEventListener('click', function() {
            const isHidden = collapseFilterSortDiv.classList.toggle('hidden');
            this.setAttribute('aria-expanded', String(!isHidden));
            this.classList.toggle('expanded', !isHidden);
        });
    }

    // --- Mass Edit Modal Logic ---
    if (openMassEditModalButton && massEditModal) {
        openMassEditModalButton.addEventListener('click', () => {
            const selectedIds = getSelectedUserIds();
            if (selectedIds.length === 0) { alert('Please select at least one user.'); return; }
            
            resetModalState(true); // Reset to initial "Cancel" state for a new operation

            if (massEditHiddenUserIdsContainer) {
                massEditHiddenUserIdsContainer.innerHTML = ''; 
                selectedIds.forEach(id => {
                    const input = document.createElement('input');
                    input.type = 'hidden'; input.name = 'selected_user_ids_for_mass_action'; input.value = id;
                    massEditHiddenUserIdsContainer.appendChild(input);
                });
            }
            massEditModal.classList.remove('hidden');
            massEditModal.setAttribute('aria-hidden', 'false');
        });
    }

    if (massEditModalHideTriggers) {
        massEditModalHideTriggers.forEach(trigger => {
            trigger.addEventListener('click', function(event) {
                const isBackdropClick = (event.target === event.currentTarget && this.classList.contains('modal-backdrop'));
                const isCancelButton = this.id === 'massEditCancelButton';
                const isCloseX = this.classList.contains('modal-close-button');

                if (isBackdropClick || isCancelButton || isCloseX) {
                    if (operationInProgress) {
                        // If "Cancel" button specifically is clicked during operation
                        if (isCancelButton && massEditCancelButton.textContent.trim().toLowerCase() === 'cancel') {
                            if (currentFetchController) {
                                currentFetchController.abort();
                                console.log("Fetch aborted by Cancel button.");
                            }
                            if(massEditProgressMessage) massEditProgressMessage.textContent = 'Operation Cancelled by user.';
                            if(massEditProgressBar) { massEditProgressBar.style.width = '100%'; massEditProgressBar.style.backgroundColor = 'orange'; }
                            if(massEditErrorDetail) massEditErrorDetail.classList.add('hidden');
                            
                            massEditCancelButton.innerHTML = 'Close';
                            massEditCancelButton.classList.remove('btn-secondary');
                            massEditCancelButton.classList.add('bg-yellow-500', 'hover:bg-yellow-600', 'text-white'); // Style as "Close after cancel"
                            
                            if(submitMassUpdateLibsBtn) submitMassUpdateLibsBtn.disabled = false;
                            if(submitMassDeleteUsersBtn) submitMassDeleteUsersBtn.disabled = false;
                            operationInProgress = false;
                            currentFetchController = null;
                            return; // Don't hide modal yet
                        } 
                        // If backdrop or X is clicked during operation
                        else if (isBackdropClick || isCloseX) {
                             if (confirm("An operation is in progress. Are you sure you want to cancel and close?")) {
                                if (currentFetchController) currentFetchController.abort();
                                hideModalAndMaybeReload(false); // Close without immediate reload
                            }
                            return; // Don't proceed further if operation was in progress and user didn't confirm close
                        }
                    }
                    // If not in progress, or if Cancel button now says "Done" or "Close"
                    hideModalAndMaybeReload(massEditCancelButton && massEditCancelButton.textContent.trim().toLowerCase().includes("done"));
                }
            });
        });
    }
    
    function triggerMassActionViaSSE(actionType) {
        const confirmationMessage = actionType === 'update_libraries' 
            ? `Are you sure you want to UPDATE LIBRARIES for all ${totalUsersForMassAction} selected users? This will replace their current library shares.`
            : `Are you sure you want to DELETE all ${totalUsersForMassAction} selected users? This will remove them from the app and attempt to remove them from Plex.`;
        if (!confirm(confirmationMessage + " This may take time and cannot be undone.")) return;

        resetModalState(true); // Reset to initial "Cancel" state for new operation
        operationInProgress = true; 

        if (!massActionTypeInput || !massEditActualForm) { operationInProgress = false; return; }
        massActionTypeInput.value = actionType;
        const formData = new FormData(massEditActualForm);

        if(massEditProgressArea) massEditProgressArea.classList.remove('hidden');
        if(massEditProgressMessage) massEditProgressMessage.innerHTML = `Initializing... (0/${totalUsersForMassAction})`;
        
        if(submitMassUpdateLibsBtn) submitMassUpdateLibsBtn.disabled = true;
        if(submitMassDeleteUsersBtn) submitMassDeleteUsersBtn.disabled = true;
        if(massEditCancelButton) massEditCancelButton.disabled = false; // Cancel remains enabled

        currentFetchController = new AbortController();

        fetch(massEditActualForm.action, { 
            method: 'POST', body: formData, 
            headers: { 'X-CSRFToken': massEditActualForm.querySelector('input[name="csrf_token"]').value },
            signal: currentFetchController.signal
        })
        .then(response => {
            if (!response.ok) { return response.text().then(text => { throw new Error(`Server error: ${response.status} - ${text || 'Unknown'}`); }); }
            if (!response.body) { throw new Error('Response body is null.'); }
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';

            function processStream({ done, value }) {
                if (currentFetchController && currentFetchController.signal.aborted) {
                    console.log("Stream processing stopped by abort signal during read.");
                    // UI for cancellation is now handled by the AbortError in catch block or cancel button logic
                    return;
                }
                if (done) {
                    console.log("SSE Stream finished by server.");
                    if(massEditProgressMessage && !massEditProgressMessage.textContent.includes("Finalizing") && !massEditProgressMessage.textContent.includes("Error:") && !massEditProgressMessage.textContent.includes("Cancelled")) {
                         massEditProgressMessage.textContent = `Operation fully completed for ${totalUsersForMassAction} users!`;
                    }
                    if(massEditProgressBar) massEditProgressBar.style.width = '100%';
                    if(massEditCancelButton) {
                        massEditCancelButton.innerHTML = '<i class="fas fa-check mr-1"></i> Done';
                        massEditCancelButton.classList.remove('btn-secondary', 'bg-yellow-500', 'hover:bg-yellow-600');
                        massEditCancelButton.classList.add('bg-green-500', 'hover:bg-green-600', 'dark:bg-green-600', 'dark:hover:bg-green-700', 'text-white');
                        massEditCancelButton.disabled = false;
                    }
                    operationInProgress = false;
                    currentFetchController = null;
                    return;
                }
                buffer += decoder.decode(value, { stream: true });
                let boundary;
                while ((boundary = buffer.indexOf('\n\n')) !== -1) {
                    const message = buffer.substring(0, boundary);
                    buffer = buffer.substring(boundary + 2); 
                    if (message.startsWith('data: ')) {
                        const dataContent = message.substring(6).trim();
                        if (dataContent.startsWith('Progress Bar')) {
                            const lines = dataContent.split('\n');
                            let userMsg = `Processing... (0/${totalUsersForMassAction})`; 
                            let errTxt = "";
                            lines.forEach(p => {
                                if (p.startsWith('Processing User')) {userMsg = p;}
                                else if (p.trim() && !p.startsWith('Progress Bar') && !p.includes('<progress>')) {errTxt += (errTxt ? "<br>" : "") + p.trim();}
                            });
                            if (massEditProgressMessage) massEditProgressMessage.innerHTML = userMsg;
                            if (massEditErrorDetail) { massEditErrorDetail.innerHTML = errTxt; massEditErrorDetail.classList.toggle('hidden', !errTxt.trim());}
                            const progressMatch = dataContent.match(/<progress>(\d+\.?\d*)/);
                            if (progressMatch && massEditProgressBar) massEditProgressBar.style.width = `${parseFloat(progressMatch[1])}%`;
                        } else if (dataContent.startsWith("RESULTS")) {
                            if (massEditProgressMessage) massEditProgressMessage.textContent = "Finalizing: " + dataContent.substring(8);
                            if (massEditProgressBar) massEditProgressBar.style.width = '100%';
                            if (massEditErrorDetail) massEditErrorDetail.classList.add('hidden');
                        } else if (dataContent.startsWith("DB_ERROR") || dataContent.startsWith("Validation Error")) {
                            if (massEditProgressMessage) massEditProgressMessage.textContent = "Error: " + dataContent;
                            if (massEditProgressBar) massEditProgressBar.style.backgroundColor = 'red';
                            if (massEditErrorDetail) massEditErrorDetail.classList.add('hidden');
                        } else if (dataContent === "FINISHED") {
                             if (massEditProgressMessage) massEditProgressMessage.textContent = "Process fully finished!";
                             if (massEditProgressBar) massEditProgressBar.style.width = '100%';
                        }
                    }
                }
                return reader.read().then(processStream);
            }
            return reader.read().then(processStream);
        })
        .catch(error => {
            operationInProgress = false; 
            if (error.name === 'AbortError') {
                console.log('Fetch aborted by user action.');
                // Message already set by cancel button's logic if it was the source
                if (massEditProgressMessage && !massEditProgressMessage.textContent.includes('Cancelled')) {
                    massEditProgressMessage.textContent = 'Operation Aborted.';
                }
                if(massEditCancelButton) { massEditCancelButton.innerHTML = 'Close'; massEditCancelButton.disabled = false; }
            } else {
                console.error('Mass action fetch/stream client-side error:', error);
                if(massEditProgressMessage) massEditProgressMessage.textContent = `Client-side error: ${error.message}.`;
                if(massEditProgressBar) { massEditProgressBar.style.width = '100%'; massEditProgressBar.style.backgroundColor = 'red'; }
            }
            if(submitMassUpdateLibsBtn) submitMassUpdateLibsBtn.disabled = false;
            if(submitMassDeleteUsersBtn) submitMassDeleteUsersBtn.disabled = false;
            if(massEditCancelButton && !massEditCancelButton.textContent.includes('Close') && !massEditCancelButton.textContent.includes('Done')) { 
                massEditCancelButton.disabled = false; 
            }
            currentFetchController = null;
        });
    }

    if (submitMassUpdateLibsBtn) submitMassUpdateLibsBtn.addEventListener('click', () => triggerMassActionViaSSE('update_libraries'));
    if (submitMassDeleteUsersBtn) submitMassDeleteUsersBtn.addEventListener('click', () => triggerMassActionViaSSE('delete_users'));
    
    document.addEventListener('keydown', (event) => { 
        if (event.key === 'Escape') {
            if (massEditModal && !massEditModal.classList.contains('hidden')) {
                if (operationInProgress && currentFetchController) {
                    currentFetchController.abort(); 
                    if(massEditProgressMessage) massEditProgressMessage.textContent = 'Operation Cancelled by Escape key.';
                    if(massEditCancelButton) { massEditCancelButton.innerHTML = 'Close'; massEditCancelButton.disabled = false; }
                    operationInProgress = false; currentFetchController = null;
                } else if (!operationInProgress) { 
                    massEditModal.classList.add('hidden'); massEditModal.setAttribute('aria-hidden', 'true');
                }
            }
            document.querySelectorAll('.modal:not(.hidden)[id^="discordIdModal-"]').forEach(om => {
                 om.classList.add('hidden'); om.setAttribute('aria-hidden', 'true');
            });
        }
    });
});
</script>
{% endblock %}