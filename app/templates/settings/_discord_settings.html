{# File: app/templates/settings/_discord_settings.html #}
<form method="POST" action="{{ url_for('dashboard.settings_discord') }}" id="mainDiscordSettingsForm">
    {{ form.hidden_tag() }}
    <h2 class="text-xl font-semibold mb-2">Discord Integration Settings</h2>
    <p class="text-sm text-base-content/70 mb-6">Configure Discord OAuth for invitees and optionally enable advanced Discord Bot features.</p>

    <div class="space-y-6">
        {# --- Section 1: OAuth for Invitees & Admin Link --- #}
        <fieldset class="border border-base-300 p-4 rounded-md min-w-0">
            <legend class="px-2 font-medium text-primary">1. OAuth for Invitees & Admin Link</legend>
            <div class="form-control w-full mb-2 mt-2">
                <label class="label cursor-pointer justify-start">
                    {{ form.enable_discord_oauth(class="toggle toggle-primary mr-3", id="enable_discord_oauth_toggle") }}
                    <span class="label-text font-medium whitespace-normal">{{ form.enable_discord_oauth.label.text }}</span>
                </label>
                {% if form.enable_discord_oauth.errors %}{% for e in form.enable_discord_oauth.errors %}<p class="text-error text-xs mt-1 whitespace-normal">{{e}}</p>{% endfor %}{% endif %}
                <p class="text-xs text-base-content/60 mt-1 whitespace-normal">
                    Enables Discord linking on public invites and for admin accounts. 
                    <strong class="text-warning">This is automatically enabled if "Discord Bot Features" (Section 2) are active.</strong>
                </p>
            </div>
            
            <div id="discord_oauth_dependent_fields" class="{{ '' if form.enable_discord_oauth.data or initial_discord_enabled_state else 'hidden' }} space-y-4 mt-3">
                <p class="text-xs text-base-content/80 mb-1 whitespace-normal">
                    Create a Discord Application in the 
                    <a href="https://discord.com/developers/applications" target="_blank" rel="noopener noreferrer" class="link link-hover text-accent">Discord Developer Portal <i class="fa-solid fa-external-link-alt fa-xs"></i></a>.
                </p>
                <p class="text-xs text-base-content/80 mb-2">Add these Redirect URIs to your Discord App's OAuth2 settings:</p>
                <div class="form-control mb-2">
                    <label class="label py-0"><span class="label-text-alt font-semibold">Redirect URI (Invites):</span></label>
                    <input type="text" readonly value="{{ discord_invite_redirect_uri }}" class="input input-bordered input-sm bg-base-300/70 cursor-pointer" onclick="this.select(); document.execCommand('copy'); showToast('URI copied!', 'success');" title="Click to copy">
                </div>
                <div class="form-control mb-4">
                    <label class="label py-0"><span class="label-text-alt font-semibold">Redirect URI (Admin Link):</span></label>
                    <input type="text" readonly value="{{ discord_admin_link_redirect_uri }}" class="input input-bordered input-sm bg-base-300/70 cursor-pointer" onclick="this.select(); document.execCommand('copy'); showToast('URI copied!', 'success');" title="Click to copy">
                </div>
                <div class="form-control w-full">
                    {{ form.discord_client_id.label(class="label") }} 
                    {{ form.discord_client_id(class="input input-bordered " + ("input-error" if form.discord_client_id.errors else ""), id="discord_client_id_input") }}
                    <p class="text-xs text-base-content/60 mt-1 whitespace-normal">{{ form.discord_client_id.description }}</p>
                    {% if form.discord_client_id.errors %}{% for e in form.discord_client_id.errors %}<p class="text-error text-xs mt-1">{{e}}</p>{% endfor %}{% endif %}
                </div>
                <div class="form-control w-full">
                    {{ form.discord_client_secret.label(class="label whitespace-normal") }} 
                    {{ form.discord_client_secret(class="input input-bordered " + ("input-error" if form.discord_client_secret.errors else ""), placeholder="Enter new secret or leave blank to keep existing", id="discord_client_secret_input") }}
                    <p class="text-xs text-base-content/60 mt-1 whitespace-normal">{{ form.discord_client_secret.description }}</p>
                    {% if form.discord_client_secret.errors %}{% for e in form.discord_client_secret.errors %}<p class="text-error text-xs mt-1">{{e}}</p>{% endfor %}{% endif %}
                </div>
                <div class="form-control w-full">
                    {{ form.discord_oauth_auth_url.label(class="label whitespace-normal") }}
                    {{ form.discord_oauth_auth_url(class="input input-bordered input-sm " + ("input-error" if form.discord_oauth_auth_url.errors else ""), placeholder="https://discord.com/oauth2/authorize?client_id=...") }}
                    <p class="text-xs text-base-content/60 mt-1 whitespace-normal">{{ form.discord_oauth_auth_url.description }}</p>
                    {% if form.discord_oauth_auth_url.errors %}{% for e in form.discord_oauth_auth_url.errors %}<p class="text-error text-xs mt-1">{{e}}</p>{% endfor %}{% endif %}
                </div>

                {# --- "Require SSO on Invite" Toggle - MOVED HERE --- #}
                <div class="form-control w-full pt-3 border-t border-base-300/20 mt-4">
                    <label class="label cursor-pointer justify-start">
                        {{ form.discord_bot_require_sso_on_invite(class="toggle toggle-accent mr-3", id="discord_require_sso_on_invite_toggle") }}
                        <span class="label-text font-medium whitespace-normal">{{ form.discord_bot_require_sso_on_invite.label.text }}</span>
                    </label>
                    <p id="discord_require_sso_help_text_dynamic" class="text-xs mt-1 pl-12 text-accent/80 {{ 'hidden' if not form.enable_discord_bot.data else '' }}">
                        This is automatically enabled and mandatory when "Discord Bot Features" (Section 2) are active.
                    </p>
                    <p id="discord_require_sso_help_text_static" class="text-xs text-base-content/60 mt-1 pl-12 {{ '' if not form.enable_discord_bot.data else 'hidden' }}">
                        {{ form.discord_bot_require_sso_on_invite.description }}
                    </p>
                    {% if form.discord_bot_require_sso_on_invite.errors %}{% for e in form.discord_bot_require_sso_on_invite.errors %}<p class="text-error text-xs mt-1 pl-12">{{e}}</p>{% endfor %}{% endif %}
                </div>
            </div>
        </fieldset>

        {# --- Section 2: Discord Bot Features --- #}
        <fieldset class="border border-base-300 p-4 rounded-md mt-6 min-w-0">
            <legend class="px-2 font-medium text-secondary">2. Discord Bot Features</legend>
            <div class="form-control w-full mb-4 mt-2">
                <label class="label cursor-pointer justify-start">
                    {{ form.enable_discord_bot(class="toggle toggle-secondary mr-3", id="enable_discord_bot_toggle") }}
                    <span class="label-text font-medium whitespace-normal">{{ form.enable_discord_bot.label.text }}</span>
                </label>
                {% if form.enable_discord_bot.errors %}{% for e in form.enable_discord_bot.errors %}<p class="text-error text-xs mt-1">{{e}}</p>{% endfor %}{% endif %}
                <p class="text-xs text-base-content/60 mt-1 whitespace-normal">{{ form.enable_discord_bot.description }}</p>
            </div>

            <div id="discord_bot_dependent_fields" class="{{ '' if form.enable_discord_bot.data else 'hidden' }} space-y-4">
                {# ... Bot Token, Guild ID, Monitored Role, Thread Channel, Log Channel, Server Invite URL fields ... #}
                 <div class="form-control w-full"> {{ form.discord_bot_token.label(class="label") }} {{ form.discord_bot_token(class="input input-bordered " + ("input-error" if form.discord_bot_token.errors else ""), placeholder="Enter new token or leave blank if already saved") }} <p class="text-xs text-base-content/60 mt-1">{{ form.discord_bot_token.description }}</p> {% if form.discord_bot_token.errors %}{% for e in form.discord_bot_token.errors %}<p class="text-error text-xs mt-1">{{e}}</p>{% endfor %}{% endif %} </div>
                <div class="form-control w-full"> {{ form.discord_guild_id.label(class="label whitespace-normal") }} {{ form.discord_guild_id(class="input input-bordered " + ("input-error" if form.discord_guild_id.errors else "")) }} <p class="text-xs text-base-content/60 mt-1">{{ form.discord_guild_id.description }}</p> {% if form.discord_guild_id.errors %}{% for e in form.discord_guild_id.errors %}<p class="text-error text-xs mt-1">{{e}}</p>{% endfor %}{% endif %} </div>
                <div class="form-control w-full"> {{ form.discord_monitored_role_id.label(class="label whitespace-normal") }} {{ form.discord_monitored_role_id(class="input input-bordered " + ("input-error" if form.discord_monitored_role_id.errors else "")) }} <p class="text-xs text-base-content/60 mt-1">{{ form.discord_monitored_role_id.description }}</p> {% if form.discord_monitored_role_id.errors %}{% for e in form.discord_monitored_role_id.errors %}<p class="text-error text-xs mt-1">{{e}}</p>{% endfor %}{% endif %} </div>
                <div class="form-control w-full"> {{ form.discord_thread_channel_id.label(class="label whitespace-normal") }} {{ form.discord_thread_channel_id(class="input input-bordered " + ("input-error" if form.discord_thread_channel_id.errors else "")) }} <p class="text-xs text-base-content/60 mt-1">{{ form.discord_thread_channel_id.description }}</p> {% if form.discord_thread_channel_id.errors %}{% for e in form.discord_thread_channel_id.errors %}<p class="text-error text-xs mt-1">{{e}}</p>{% endfor %}{% endif %} </div>
                <div class="form-control w-full"> {{ form.discord_bot_log_channel_id.label(class="label whitespace-normal") }} {{ form.discord_bot_log_channel_id(class="input input-bordered " + ("input-error" if form.discord_bot_log_channel_id.errors else "")) }} <p class="text-xs text-base-content/60 mt-1">{{ form.discord_bot_log_channel_id.description }}</p> {% if form.discord_bot_log_channel_id.errors %}{% for e in form.discord_bot_log_channel_id.errors %}<p class="text-error text-xs mt-1">{{e}}</p>{% endfor %}{% endif %} </div>
                <div class="form-control w-full"> {{ form.discord_server_invite_url.label(class="label whitespace-normal") }} {{ form.discord_server_invite_url(class="input input-bordered " + ("input-error" if form.discord_server_invite_url.errors else "")) }} <p class="text-xs text-base-content/60 mt-1">{{ form.discord_server_invite_url.description }}</p> {% if form.discord_server_invite_url.errors %}{% for e in form.discord_server_invite_url.errors %}<p class="text-error text-xs mt-1">{{e}}</p>{% endfor %}{% endif %} </div>
                
                <div class="form-control w-full">
                    <label class="label cursor-pointer justify-start">
                        {{ form.discord_bot_whitelist_sharers(class="toggle toggle-info mr-3") }}
                        <span class="label-text font-medium whitespace-normal">{{ form.discord_bot_whitelist_sharers.label.text }}</span>
                    </label>
                    <p class="text-xs text-base-content/60 mt-1">{{ form.discord_bot_whitelist_sharers.description }}</p>
                    {% if form.discord_bot_whitelist_sharers.errors %}{% for e in form.discord_bot_whitelist_sharers.errors %}<p class="text-error text-xs mt-1">{{e}}</p>{% endfor %}{% endif %}
                </div>
            </div>
        </fieldset>

        <div class="form-control mt-10 pt-6 border-t border-base-300">
            {{ form.submit(class="btn btn-primary w-full sm:w-auto", value="Save Discord Settings") }}
        </div>
    </div>
</form>

{# Admin Account Link Section - (Make sure this is OUTSIDE the mainDiscordSettingsForm) #}
<div class="divider mt-8">Admin Discord Account Link</div>
<p class="text-sm text-base-content/70 mb-4">Link your own Discord account for potential future admin-specific bot features or easier management.</p>
<div id="discord_admin_link_status_container">
    {# This uses `initial_discord_enabled_state` which should be passed from the route and reflect the saved DISCORD_OAUTH_ENABLED state #}
    {% if initial_discord_enabled_state %}
        {% if discord_admin_linked and discord_admin_user_info %}
            <div class="alert alert-success mb-4"> {# Removed custom colors for DaisyUI theme consistency #}
                <i class="fa-brands fa-discord fa-lg mr-2"></i>
                <div>
                    <h3 class="font-bold">Admin Discord Linked!</h3>
                    <div class="text-xs">Username: <strong>{{ discord_admin_user_info.username }}</strong>{% if discord_admin_user_info.id %} (ID: {{ discord_admin_user_info.id }}){% endif %}</div>
                    {% if discord_admin_user_info.avatar and discord_admin_user_info.id %}
                    <div class="avatar my-2">
                        <div class="w-12 rounded-full ring ring-primary ring-offset-base-100 ring-offset-1">
                            <img src="https://cdn.discordapp.com/avatars/{{ discord_admin_user_info.id }}/{{ discord_admin_user_info.avatar }}.png?size=64" alt="Admin Avatar">
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            <form method="POST" action="{{ url_for('auth.discord_unlink_admin') }}" id="unlinkAdminDiscordForm" class="mt-4">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit" form="unlinkAdminDiscordForm" class="btn btn-error btn-sm">
                    <i class="fa-solid fa-link-slash mr-2"></i> Unlink My Discord
                </button>
            </form>
        {% else %}
            <div class="alert alert-info mb-4 text-sm p-3">
                <i class="fa-solid fa-info-circle mr-2"></i>
                <span>Your admin account is not yet linked to Discord.</span>
            </div>
            <form method="POST" action="{{ url_for('auth.discord_link_admin') }}" id="linkAdminDiscordForm" class="mt-4">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit" id="linkAdminDiscordButton" form="linkAdminDiscordForm" class="btn btn-info btn-sm"> {# Use DaisyUI btn-info #}
                    <i class="fa-brands fa-discord mr-2"></i> Link My Discord Account
                </button>
            </form>
        {% endif %}
    {% else %}
        <div class="alert alert-warning my-4 text-sm p-3">
            <i class="fa-solid fa-triangle-exclamation fa-lg mr-2"></i>
            <span>Enable "OAuth for Invitees & Admin Link" (Section 1 above) and save settings to allow linking your admin Discord account.</span>
        </div>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const oauthToggle = document.getElementById('enable_discord_oauth_toggle');
    const oauthFieldsDiv = document.getElementById('discord_oauth_dependent_fields');
    
    const botToggle = document.getElementById('enable_discord_bot_toggle');
    const botFieldsDiv = document.getElementById('discord_bot_dependent_fields');
    
    const requireSsoToggleInput = document.getElementById('discord_require_sso_on_invite_toggle');
    const requireSsoHelpTextDynamic = document.getElementById('discord_require_sso_help_text_dynamic');
    const requireSsoHelpTextStatic = document.getElementById('discord_require_sso_help_text_static');

    function updateFieldVisibilityAndRequirements() {
        let isOAuthEnabled = oauthToggle ? oauthToggle.checked : false;
        let isBotEnabled = botToggle ? botToggle.checked : false;

        // If bot is enabled, force OAuth enabled visually and functionally for this interaction
        if (isBotEnabled && oauthToggle && !oauthToggle.checked) {
            oauthToggle.checked = true;
            isOAuthEnabled = true; 
        }

        if (oauthFieldsDiv) oauthFieldsDiv.classList.toggle('hidden', !isOAuthEnabled);
        if (botFieldsDiv) botFieldsDiv.classList.toggle('hidden', !isBotEnabled);
        
        if (requireSsoToggleInput) {
            if (!isOAuthEnabled) { // If main OAuth is off, this must be off and disabled
                requireSsoToggleInput.checked = false;
                requireSsoToggleInput.disabled = true;
                if (requireSsoHelpTextDynamic) requireSsoHelpTextDynamic.classList.add('hidden');
                if (requireSsoHelpTextStatic) requireSsoHelpTextStatic.classList.remove('hidden');
            } else if (isBotEnabled) { // Main OAuth is ON (or forced ON), and Bot is ON
                requireSsoToggleInput.checked = true;
                requireSsoToggleInput.disabled = true;
                if (requireSsoHelpTextDynamic) requireSsoHelpTextDynamic.classList.remove('hidden');
                if (requireSsoHelpTextStatic) requireSsoHelpTextStatic.classList.add('hidden');
            } else { // Main OAuth is ON, Bot is OFF
                requireSsoToggleInput.disabled = false;
                // The .data for form.discord_bot_require_sso_on_invite will set its initial checked state from Python
                if (requireSsoHelpTextDynamic) requireSsoHelpTextDynamic.classList.add('hidden');
                if (requireSsoHelpTextStatic) requireSsoHelpTextStatic.classList.remove('hidden');
            }
        }
    }

    if (oauthToggle) oauthToggle.addEventListener('change', updateFieldVisibilityAndRequirements);
    if (botToggle) botToggle.addEventListener('change', updateFieldVisibilityAndRequirements);

    updateFieldVisibilityAndRequirements(); // Initial call
});
</script>