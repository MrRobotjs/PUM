<!-- File: app/templates/settings/_roles_settings.html -->
<h2 class="text-xl font-semibold mb-6">Manage Roles</h2>
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <div class="lg:col-span-2 card bg-base-100 shadow">
        <div class="card-body">
            <h2 class="card-title">Existing Roles</h2>
            <div class="overflow-x-auto">
                <table class="table">
                    <thead><tr><th>Name</th><th>Description</th><th>Assigned Admins</th><th>Badge</th><th>Actions</th></tr></thead>
                    <tbody>
                    {% for role in roles %}
                    <tr>
                        <td class="font-semibold">{{ role.name }}</td>
                        <td>{{ role.description }}</td>
                        <td>{{ role.admins|length }}</td>
                        <td class="font-semibold">
                            <span class="badge" style="background-color: {{ role.color or '#808080' }}; border-color: {{ role.color or '#808080' }}; color: {{ get_text_color_for_bg(role.color) }};">
                                {{ role.name }}
                            </span>
                        </td>
                        <td class="space-x-1">
                            <a href="{{ url_for('dashboard.edit_role', role_id=role.id) }}" class="btn btn-xs btn-outline">Edit</a>
                            <form action="{{ url_for('dashboard.delete_role', role_id=role.id) }}" method="POST" class="inline" onsubmit="return confirm('Are you sure you want to delete this role?');">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <button type="submit" class="btn btn-xs btn-error">Delete</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <div class="lg:col-span-1 card bg-base-100 shadow">
        <div class="card-body">
            <h2 class="card-title">Create New Role</h2>
            <form method="POST" action="{{ url_for('dashboard.settings_roles') }}" id="createRoleForm">
                {{ form.hidden_tag() }}
                
                <div class="form-control">
                    {{ form.name.label(class="label") }}
                    {{ form.name(class="input input-bordered", id="create_role_name") }}
                </div>
                <div class="form-control">
                    {{ form.description.label(class="label") }}
                    {{ form.description(class="input input-bordered") }}
                </div>
                <div class="form-control">
                    {{ form.color.label(class="label") }}
                    <div class="input-group">
                        <input type="color" value="{{ form.color.data or '#808080' }}" class="input input-bordered !p-1" id="create_color_picker">
                        {{ form.color(class="input input-bordered", id="create_color_text") }}
                    </div>
                </div>

                {# --- NEW: Live Preview Section --- #}
                <div class="form-control mt-4">
                    <label class="label"><span class="label-text">Badge Preview:</span></label>
                    <div class="p-2 border rounded-md border-base-300">
                        <span class="badge" id="create_badge_preview" style="background-color: #808080; border-color: #808080; color: #FFFFFF;">
                            New Role
                        </span>
                    </div>
                </div>
                {# --- END NEW --- #}
                
                <div class="form-control mt-4">
                    {{ form.submit(class="btn btn-primary") }}
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // This script should ideally be self-contained or use unique function names
    // to avoid conflicts if it's loaded on the same page as the edit script via HTMX.
    // For now, we will assume it's on a full page load.
    
    // Helper function for text color (JS version)
    function getTextColorForBg(hexColor) {
        if (!hexColor || hexColor.length !== 7) return '#FFFFFF';
        try {
            const r = parseInt(hexColor.substr(1, 2), 16);
            const g = parseInt(hexColor.substr(3, 2), 16);
            const b = parseInt(hexColor.substr(5, 2), 16);
            const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
            return luminance > 0.5 ? '#000000' : '#FFFFFF';
        } catch (e) {
            return '#FFFFFF';
        }
    }

    const createPicker = document.getElementById('create_color_picker');
    const createText = document.getElementById('create_color_text');
    const createName = document.getElementById('create_role_name');
    const createBadgePreview = document.getElementById('create_badge_preview');

    function updateCreatePreview() {
        if (!createBadgePreview || !createName || !createText) return;
        const name = createName.value.trim() || 'New Role';
        const color = createText.value;
        createBadgePreview.textContent = name;
        createBadgePreview.style.backgroundColor = color;
        createBadgePreview.style.borderColor = color;
        createBadgePreview.style.color = getTextColorForBg(color);
    }
    
    if (createPicker && createText) {
        // CORRECTED: Use the 'create' prefixed variables here
        createPicker.addEventListener('input', () => { 
            createText.value = createPicker.value; 
            updateCreatePreview(); 
        });
        createText.addEventListener('input', () => {
            // Add basic validation for the text input
            if (/^#[0-9a-fA-F]{6}$/.test(createText.value)) {
                createPicker.value = createText.value;
            }
            updateCreatePreview();
        });
    }
    if (createName) {
        createName.addEventListener('input', updateCreatePreview);
    }
    // Initial call to set the preview correctly
    if(document.getElementById('createRoleForm')){
        updateCreatePreview();
    }
</script>